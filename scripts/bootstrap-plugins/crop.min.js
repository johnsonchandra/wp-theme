/* Crop */
var CROP=function(){return function(){this.eles={ele:void 0,container:void 0,img:void 0,overlay:void 0,preview:void 0,original:void 0},this.img=void 0,this.imgInfo={aw:0,ah:0,w:0,h:0,at:0,al:0,t:0,l:0,s:1},this.init=function(a){function k(a){var b=a.val(),c=a.attr("min"),d=a.attr("max"),e=Math.round((b-c)/(d-c)*100),f="background: linear-gradient(to right, #fbc93d "+e+"%, #eee "+(e+.1)+"%);";a.attr("style",f)}$(a.container).attr({"data-imgcrop":"","data-mask":a.mask}).append('<input type="range" value="'+a.zoom.min+'" min="'+a.zoom.min+'" max="'+a.zoom.max+'" step="'+a.zoom.steps+'"><div class="crop-main"></div>'),this.imgInfo.s=a.zoom.min;var g,h,i,c=$(a.container),d=c.find("input"),e=c.find(".crop-main"),f=a.preview,j=this;h=$("<div />").attr({"class":"crop-container"}).css({width:a.width+"px",height:a.height+"px"}),g=$("<img />").attr("class","crop-img").css({zIndex:5999,top:0,left:0}),i=$("<div />").attr({"class":"crop-overlay",draggable:"true"}).css({zIndex:6e3}),h.append(i),h.append(g),e.append(h),this.eles.ele=e,this.eles.container=h,this.eles.img=g,this.eles.overlay=i,this.eles.preview=f,this.loadImg(a.image),h.resize(function(){j.imgSize()}),i.bind("mousedown touchstart",function(a){$("body").addClass("grabcursor");var b=$(this),c={x:a.originalEvent.pageX||a.originalEvent.touches[0].pageX,y:a.originalEvent.pageY||a.originalEvent.touches[0].pageY},d={x:b.parent().offset().left,y:b.parent().offset().top};return a.preventDefault(),$(document).bind("mousemove touchmove",function(a){var e={x:a.originalEvent.pageX||a.originalEvent.changedTouches[0].pageX||c.x,y:a.originalEvent.pageY||a.originalEvent.changedTouches[0].pageY||c.y};c.y!==e.y&&(0===parseInt(b.css("top"))&&b.css({top:j.eles.ele.offset().top,left:j.eles.ele.offset().left}),j.imgMove({t:parseInt(b.css("top"))-(d.y-(c.y-e.y)),l:parseInt(b.css("left"))-(d.x-(c.x-e.x))}),b.css({left:d.x-(c.x-e.x),top:d.y-(c.y-e.y)}))}),$(document).bind("mouseup touchend",function(a){$("body").removeClass("grabcursor"),$(document).unbind("mousemove touchmove"),i.css({top:0,left:0})}),!1}),$("input[type=range]").on("input change",function(){j.slider(d.val()),k(d)}),j.zoom=function(a){if("min"===a||"max"===a)var a=parseInt(d.attr(a));j.slider(a),d.val(a),k(d)}},this.loadImg=function(a){var b=this,c=new Image,d=document.createElement("canvas");c.src=a,c.onload=function(){d.width=c.naturalWidth,d.height=c.naturalHeight,d.getContext("2d").drawImage(c,0,0),b.originalImage={width:c.naturalWidth,height:c.naturalHeight,type:d.toDataURL("image/jpeg").split(",")[0].split(":")[1].split(";")[0].split("/")[1],string:d.toDataURL("image/jpeg")}},this.eles.img.removeAttr("style").attr("src",a).load(function(){b.imgSize()})},this.imgSize=function(){var a=this.eles.img,b={w:a.css("width","").width(),h:a.css("height","").height()},c=this.eles.container,d={wh:this.eles.container.width()/this.eles.container.height(),hw:this.eles.container.height()/this.eles.container.width()};this.imgInfo.aw=b.w,this.imgInfo.ah=b.h,b.w*d.hw<b.h*d.wh?(this.imgInfo.w=c.width(),this.imgInfo.h=Math.round(this.imgInfo.w*(b.h/b.w)),this.imgInfo.al=0):(this.imgInfo.h=c.height(),this.imgInfo.w=Math.round(this.imgInfo.h*(b.w/b.h)),this.imgInfo.at=0),this.imgResize()},this.imgResize=function(a){var b=this.eles.img,c=this.imgInfo,d=c.s;c.s=a||c.s,b.css({width:c.w*c.s,height:c.h*c.s}),this.imgMove({t:-Math.round(c.h*d-c.h*c.s)/2,l:-Math.round(c.w*d-c.w*c.s)/2})},this.imgMove=function(a){var b=this.eles.img,c=this.imgInfo,d=this.eles.container;c.t+=a.t,c.l+=a.l;var e=c.at-c.t,f=c.al-c.l;e>=0?e=c.t=0:e<-(c.h*c.s-d.height())&&(e=-(c.h*c.s-d.height()),c.t=0===c.at?c.h*c.s-d.height():c.h*c.s-d.height()),f>=0?f=c.l=0:f<-(c.w*c.s-d.width())&&(f=-(c.w*c.s-d.width()),c.l=0===c.al?c.w*c.s-d.width():c.w*c.s-d.width()),b.css({top:e,left:f}),this.eles.preview&&this.preview(this.eles.preview.width,this.eles.preview.height,this.eles.preview.container)},this.slider=function(a){this.imgResize(a)},this.crop=function(a,b,c){var d=this.imgInfo,e=this.eles.container,f=this.eles.img,g=new Image,h=document.createElement("canvas");g.src=f.attr("src"),h.width=a,h.height=b;var i=Math.round(e.width()*(d.aw/(d.w*d.s))),j=Math.round(e.height()*(d.ah/(d.h*d.s))),k=Math.round(-parseInt(f.css("left"))*(d.aw/(d.w*d.s))),l=Math.round(-parseInt(f.css("top"))*(d.ah/(d.h*d.s)));return h.getContext("2d").drawImage(g,k,l,i,j,0,0,a,b),{width:a,height:b,type:c||"png",string:h.toDataURL("image/"+c||"png")}},this.original=function(){return this.originalImage},this.preview=function(a,b,c){var d=this.eles.container,e=this.eles.img;$(c+" img").length||$(c).css({height:d.height(),width:d.width(),overflow:"hidden",margin:"0 auto",padding:0,transform:"scale("+this.eles.preview.ratio+")"}).append("<img>"),$(c+" img").attr("src",e.attr("src")).attr("style","position:relative;"+$(".crop-img").attr("style"))},this.flip=function(){var a=this,c=(a.imgInfo,a.eles.container),d=a.eles.img,e=new Image;e.src=d.attr("src"),height=e.naturalHeight,width=e.naturalWidth,canvas=document.createElement("canvas"),canvas.width=width,canvas.height=height,canvas.getContext("2d").translate(width,0),canvas.getContext("2d").scale(-1,1),canvas.getContext("2d").drawImage(e,0,0),canvas.getContext("2d").translate(width,0),canvas.getContext("2d").scale(-1,1),c.find(".crop-img").removeAttr("style").attr("src",canvas.toDataURL())},this.rotate=function(){var a=this,c=(a.imgInfo,a.eles.container),d=a.eles.img,e=new Image;e.src=d.attr("src"),height=e.naturalHeight,width=e.naturalWidth,canvas=document.createElement("canvas"),canvas.width=height,canvas.height=width,canvas.getContext("2d").translate(canvas.width/2,canvas.height/2),canvas.getContext("2d").rotate(Math.PI/2),canvas.getContext("2d").drawImage(e,-width/2,-height/2),canvas.getContext("2d").rotate(-Math.PI/2),canvas.getContext("2d").translate(-canvas.width/2,-canvas.height/2),c.find(".crop-img").removeAttr("style").attr("src",canvas.toDataURL())},this.download=function(a,b,c,d,e){var f=this,g=f.imgInfo,h=f.eles.container,i=f.eles.img,j=new Image;j.src=i.attr("src");var k=document.createElement("canvas");k.width=a,k.height=b;var l=Math.round(h.width()*(g.aw/(g.w*g.s))),m=Math.round(h.height()*(g.ah/(g.h*g.s))),n=Math.round(-parseInt(i.css("left"))*(g.aw/(g.w*g.s))),o=Math.round(-parseInt(i.css("top"))*(g.ah/(g.h*g.s)));k.getContext("2d").drawImage(j,n,o,l,m,0,0,a,b),$("#"+e).attr("href",k.toDataURL("image/"+d)).attr("download",c+"."+d)},this["import"]=function(){var a=this;$("body").append('<input type="file" id="choose-img" style="display:none">');var f,b=this,d=(b.imgInfo,b.eles.container);b.eles.img;oFReader=new FileReader,$("#choose-img").change(function(){if(0!==document.getElementById("choose-img").files.length){var a=document.getElementById("choose-img").files[0];/^(image\/gif|image\/jpeg|image\/png)$/i.test(a.type)&&(f=this.value.replace(/^.*[\\\/]/,""),f=f.substr(0,f.lastIndexOf(".")),oFReader.readAsDataURL(a),$("#choose-img").remove())}}),oFReader.onload=function(b){d.find(".crop-img").removeAttr("style").attr("src",b.target.result);var c=new Image;c.src=b.target.result,a.originalImage={width:c.naturalWidth,height:c.naturalHeight,name:f,type:b.target.result.split(",")[0].split(":")[1].split(";")[0].split("/")[1],string:b.target.result}},$("#choose-img").click()}}}();